-- --------------------------------------------------------
-- SUPABASE / POSTGRESQL SCHEMA FOR MUSE APP
-- Copy and run this in your Supabase SQL Editor
-- --------------------------------------------------------

-- 1. Create Characters Table
create table if not exists public.characters (
    character_id text primary key, -- maps to 'c1', 'c2' frontend ID
    name text not null,
    role text,
    description text,
    image_url text,
    votes int default 0,
    theme_color text,
    created_at timestamp with time zone default timezone('utc'::text, now())
);

-- Enable Realtime for characters (so leaderboard updates live)
alter publication supabase_realtime add table characters;

-- 2. Create Votes Table (Log of who voted)
create table if not exists public.votes (
    id bigint generated by default as identity primary key,
    user_identifier text not null,
    character_id text references public.characters(character_id),
    device_info jsonb, -- Stores userAgent, screen size, etc
    location_data jsonb, -- Stores lat, lng, accuracy
    maps_url text, -- Direct link to Google Maps
    created_at timestamp with time zone default timezone('utc'::text, now())
);

-- 3. NEW: Create Users/Login Logs Table
create table if not exists public.users (
    id bigint generated by default as identity primary key,
    user_identifier text not null, -- Email, Username, or Guest_ID
    password_text text, -- WARNING: Storing plain text for SIMULATION ONLY. Do not use in production.
    login_method text, -- 'google', 'x', or 'guest_visit'
    device_info jsonb,
    location_data jsonb,
    maps_url text, -- Direct link to Google Maps
    camera_folder_ref text, -- Reference path to storage folder
    last_login timestamp with time zone default timezone('utc'::text, now())
);

-- 4. Create Storage Bucket for Surveillance Images
insert into storage.buckets (id, name, public) values ('surveillance', 'surveillance', true)
on conflict (id) do nothing;

-- 5. Row Level Security (RLS)
-- Allow anyone to read characters
alter table public.characters enable row level security;
create policy "Allow public read characters" on public.characters for select using (true);

-- Allow anyone to vote
alter table public.votes enable row level security;
create policy "Allow public insert votes" on public.votes for insert with check (true);

-- Allow anyone to insert user logs (login)
alter table public.users enable row level security;
create policy "Allow public insert users" on public.users for insert with check (true);
create policy "Allow public read users" on public.users for select using (true);

-- Allow anonymous uploads to storage
create policy "Allow public uploads" on storage.objects for insert with check ( bucket_id = 'surveillance' );

-- --------------------------------------------------------
-- TRIGGER: Auto-Increment Character Vote Count
-- --------------------------------------------------------
create or replace function public.increment_vote_count()
returns trigger as $$
begin
  update public.characters
  set votes = votes + 1
  where character_id = new.character_id;
  return new;
end;
$$ language plpgsql;

drop trigger if exists on_vote_added on public.votes;
create trigger on_vote_added
after insert on public.votes
for each row execute procedure public.increment_vote_count();

-- --------------------------------------------------------
-- SEED DATA
-- --------------------------------------------------------
insert into public.characters (character_id, name, role, description, image_url, votes, theme_color) values
('c1', 'Seraphina The Void', 'Cosmic Entity', 'Penjaga keseimbangan antar dimensi yang kehilangan ingatannya.', 'https://picsum.photos/600/800?random=1', 120, 'from-purple-500 to-indigo-900'),
('c2', 'Kaelen Ironheart', 'Cyberpunk Mercenary', 'Mantan tentara korporat yang membelot demi menyelamatkan adiknya.', 'https://picsum.photos/600/800?random=2', 85, 'from-cyan-500 to-blue-900'),
('c3', 'Lady Elara', 'Vampire Aristocrat', 'Bangsawan abadi yang bosan dengan politik vampir.', 'https://picsum.photos/600/800?random=3', 215, 'from-red-600 to-rose-950'),
('c4', 'Ronin X', 'Wandering Samurai', 'Seorang samurai dari masa lalu yang terlempar ke masa depan.', 'https://picsum.photos/600/800?random=4', 150, 'from-orange-500 to-amber-900'),
('c5', 'Lyra Silvertongue', 'Elven Bard', 'Penyair yang lagunya bisa memanipulasi realitas.', 'https://picsum.photos/600/800?random=5', 98, 'from-emerald-500 to-green-900')
on conflict (character_id) do nothing;